---
layout: post
title: "Docker in Docker"
subtitle: "A Jenkins Adventure"
bigimg: /img/dind.gif
tags: [docker, jenkins, docker-in-docker, dind]
comments: true
draft: true
output:
  html_document:
    keep_md: true
---

Eu imagino que minha história é muito parecida com a de tantas outras pessoas trabalhando com CICD.

Você começa a montar a esteira CICD usando Jenkins, e um determinado momento vem o pensamento:

> "Por quê não executar o Jenkins em um container docker?"

E, como um raio, um segundo pessamento cai sobre você:

> "Qual docker (executável) o Jenkins vai utilizar para os *builds*?"

A partir daí, é um caminho sem volta de tentativas e de buscar alguma solução entre documentações, blogs e forúns online.

<center>
<img src="/img/tabs.gif" style="display: block; margin: auto;height: 220px;">
</center>

Independente do percurso, todos temos um mesmo checkpoint: o [artigo de Jérôme Petazzoni](http://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/) sobre Docker-in-Docker (dind, para os intimos).

De forma pratica, ao falar de dind, estamos nos referindo a um container docker com uma instalação docker que permite executar outros containers...

(...) que podem ser outros containers docker-in-docker que podem executar outros containers docker-in-docker...

<center>
<img src="/img/inception.gif" style="display: block; margin: auto;height: 220px;">
</center>

No artigo, temos um dos contribuidores da flag `--privileged`, essencial para a execução do dind, criticando o uso do dind para determinados cenários - inclusive para o Jenkins.

Nesse mesmo artigo, uma solução é apresentada: montar o `docker.sock` da máquina host como forma do container contendo o Jenkins executar e guardar seu cache no Docker instalado no host.

Longe, de dizer qual das duas alternativas é a "correta". Neste post, quero discutir alguns dos pontos envolvendo essas abordagens.


## TL;DR

A abordagem de montar o `docker.sock` no container, de fato, soluciona as potenciais questões de data corruption (compartilhamento do `/var/lib/docker`) e de incompatibilidade entre *filesystem* relacionadas ao docker-in-docker.

Por outro lado, ao expor o `docker.sock` para o container, este se torna um ponto de vulnerabilidade em termos de segurança por dar acesso completo ao usuário (root) ao docker da máquina host - tornando possível executar containers com código malicioso. No caso de um usuário não-root, a situação ainda piorá pela necessidade de alteração das permissões do `docker.sock`.

Finalmente, o que vai decidir a melhor abordagem são os requisitos de seu projeto e a análise dos potenciais riscos em seu ambiente produtivo.

Para facilitar o teste/implementação das abordagens citadas, disponibilizei os seguintes arquivos `docker-compose` com as instruções necessárias para executar sua aplicação Jenkins com dind ou a montagem do socket.

### Jenkins associado a um container docker-in-docker

<script src="https://gist.github.com/adelmofilho/5a30a87eaf1cd4a03052f37b516d6714.js"></script>

### Container Jenkins com o docker.sock montado

<script src="https://gist.github.com/adelmofilho/5e4b2a57b402e218300332dd0a88a881.js"></script>